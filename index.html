<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ë³´ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f3f4f6;
        }

        .loading {
            text-align: center;
            padding: 10px;
            color: gray;
        }

        /* ë²„íŠ¼ ê³ ì • ìœ„ì¹˜ */
        /* ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ ë° ê³ ì • */
        .macro-buttons {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #ddd;
            max-width: 100%;
            /* ëª¨ë°”ì¼ì—ì„œë„ ê°€ë“ ì°¨ê²Œ */
            width: 100%;
            flex-wrap: wrap;
            /* ë²„íŠ¼ì´ ë§ì•„ì§€ë©´ ì¤„ë°”ê¿ˆ */
        }

        .macro-button {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }

        .macro-button:hover {
            background: rgba(37, 99, 235, 1);
        }

        #chat-container {
            max-height: 750px;
            overflow-y: auto;
            width: 100%;
            scroll-behavior: smooth;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            position: relative; /* chat-containerì˜ ë°°ê²½ì´ ìœ ì§€ë˜ë„ë¡ ì„¤ì • */
            max-width: 420px;
            transition: background-image 3s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ */
        }

        .chat-bubble {
            padding: 12px;
            border-radius: 12px;
            opacity: 0.85;
        }

        .chat-user {
            background-color: rgba(59, 130, 246, 0.75);
            color: white;
        }

        .chat-other {
            background-color: rgba(236, 72, 153, 0.75);
            color: white;
        }

        /* ë©”ì‹œì§€ ì¸ë±ìŠ¤ ìŠ¤íƒ€ì¼ */
        .message-index {
            font-size: 12px;
            color: rgb(0, 0, 0);
            margin-left: 8px;
        }

        @media (max-width: 640px) {
            .macro-buttons {
                max-width: 100%;
                /* ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œí­ ë§ì¶”ê¸° */
                justify-content: center;
            }

            #chat-container {
                max-height: 85vh;
                border-radius: 0;
                box-shadow: none;
            }

            .message {
                max-width: 80%;
            }
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col items-center min-h-screen px-2">
    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ìë™ ì¬ìƒ + ë°˜ë³µ) -->
    <audio id="bg-music" autoplay loop>
        <source src="music/audio.m4a" type="audio/mp3">
        ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </audio>
    
    <!-- ìŒì•… ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
    <div class="fixed bottom-5 right-5 p-3 bg-blue-500 text-white rounded-full cursor-pointer" id="music-toggle">
        ğŸµ ìŒì•… ë„ê¸°
    </div>
    
    <div class="macro-buttons">
        <button class="macro-button" onclick="scrollToMessage(1)">ì²˜ìŒìœ¼ë¡œ</button>
        <button class="macro-button" onclick="scrollToMessage(7549)">ì²˜ìŒë§ë†“ì€ë‚ </button>
        <button class="macro-button" onclick="scrollToMessage(13936)">ì²« ì‚¬ë‘í•´</button>
        <button class="macro-button" onclick="scrollToMessage(102614)">ë§ˆì§€ë§‰ìœ¼ë¡œ</button>
    </div>
    <!-- ì±„íŒ… ë°•ìŠ¤ -->
    <div class="w-full max-w-md bg-white shadow-lg rounded-lg p-4 relative" id="chat-container">
        <!-- <div id="background-fade"></div> -->
        <div id="messages"></div>
        <div class="loading" id="loading">ë¡œë”© ì¤‘...</div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const bgMusic = document.getElementById("bg-music");
        const musicToggle = document.getElementById("music-toggle");
        const chatContainer = document.getElementById("chat-container"); // ì±„íŒ…ì°½ ìš”ì†Œ
        let musicPlayed = false; // ìŒì•…ì´ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë³€ìˆ˜

        async function playMusic() {
            try {
                await bgMusic.play();
                bgMusic.muted = false; // ğŸ”¥ ì†Œë¦¬ ì¼œê¸°
                musicToggle.textContent = "ğŸµ ìŒì•… ë„ê¸°";
                musicPlayed = true; // í•œ ë²ˆ ì‹¤í–‰ë˜ë©´ ë‹¤ì‹œ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
                console.log("ğŸµ ìŒì•… ìë™ ì¬ìƒ ì„±ê³µ!");
            } catch (error) {
                console.error("â›” ìŒì•… ìë™ ì¬ìƒ ì°¨ë‹¨ë¨. ë°˜ë“œì‹œ ì‚¬ìš©ì ì¸í„°ë™ì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        // ğŸ“Œ **ì‚¬ìš©ìì˜ ëª¨ë“  ì¸í„°ë™ì…˜(í´ë¦­, í„°ì¹˜, í‚¤ ì…ë ¥, ìŠ¤í¬ë¡¤)ì„ ê°ì§€í•˜ì—¬ ìë™ ì¬ìƒ**
        function handleUserInteraction() {
            if (!musicPlayed) {
                playMusic();
                removeInteractionListeners(); // ğŸ¯ í•œ ë²ˆ ì‹¤í–‰ë˜ë©´ ì´ë²¤íŠ¸ ì œê±°
            }
        }

        function removeInteractionListeners() {
            chatContainer.removeEventListener("scroll", handleUserInteraction);
            document.removeEventListener("click", handleUserInteraction);
            document.removeEventListener("keydown", handleUserInteraction);
            document.removeEventListener("touchstart", handleUserInteraction);
        }

        // ğŸ“Œ **ìŠ¤í¬ë¡¤, í´ë¦­, í‚¤ ì…ë ¥, í„°ì¹˜ ì¤‘ í•˜ë‚˜ë¼ë„ ê°ì§€ë˜ë©´ ìë™ ì¬ìƒ**
        chatContainer.addEventListener("scroll", () => {
            if (chatContainer.scrollTop > 50) { // ë„ˆë¬´ ë¯¼ê°í•˜ì§€ ì•Šê²Œ ì„¤ì •
                handleUserInteraction();
            }
        });

        document.addEventListener("click", handleUserInteraction);
        document.addEventListener("keydown", handleUserInteraction);
        document.addEventListener("touchstart", handleUserInteraction);

        // ğŸµ ìŒì•… ON/OFF ë²„íŠ¼ ê¸°ëŠ¥
        musicToggle.addEventListener("click", function () {
            if (bgMusic.paused) {
                playMusic();
            } else {
                bgMusic.pause();
                musicToggle.textContent = "ğŸ”‡ ìŒì•… ì¼œê¸°";
            }
        });
    });
</script>
<script>
        const chatContainer = document.getElementById("chat-container");
        const messageContainer = document.getElementById("messages");
        const loadingIndicator = document.getElementById("loading");

        let chatData = [];
        let currentIndex = 0;
        const batchSize = 20;
        let messageElements = []; // ì±„íŒ… ë©”ì‹œì§€ ì €ì¥


        
        const backgroundImages = Array.from({ length: 51 }, (_, i) => `image/${i + 1}.jpg`);
        let currentImageIndex = 0;
        const changeInterval = 5000; // âœ… ë³€ê²½ ê°„ê²©ì„ 15ì´ˆë¡œ ì¡°ì •
        
        function setDefaultBackground() {
            document.getElementById("chat-container").style.backgroundImage = `url('${backgroundImages[0]}')`;
            console.log("âœ… ì´ˆê¸° ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì •:", backgroundImages[0]);
        }
        
        function changeBackgroundImage() {
            currentImageIndex = (currentImageIndex + 1) % backgroundImages.length;
            const newImage = backgroundImages[currentImageIndex];
            const chatContainer = document.getElementById("chat-container");
        
            console.log("ğŸ”„ ë³€ê²½í•  ë°°ê²½ ì´ë¯¸ì§€:", newImage);
        
            // ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ê¹œë¹¡ì„ ë°©ì§€)
            const img = new Image();
            img.src = newImage;
            img.onload = () => {
                chatContainer.style.transition = "opacity 1s ease-in-out"; // âœ… í˜ì´ë“œ íš¨ê³¼ë¥¼ ë” ë¶€ë“œëŸ½ê²Œ ì¡°ì •
                chatContainer.style.opacity = 0.8; // í˜ì´ë“œì•„ì›ƒ
        
                setTimeout(() => {
                    chatContainer.style.backgroundImage = `url('${newImage}')`;
                    chatContainer.style.opacity = 1; // í˜ì´ë“œì¸
                }, 1000);
            };
        }
        
        // ì´ˆê¸° ë°°ê²½ ì„¤ì •
        setDefaultBackground();
        
        // âœ… ì¼ì • ê°„ê²©ì„ 15ì´ˆ(15000ms)ë¡œ ëŠ˜ë ¤ì„œ ë°°ê²½ì´ ë” ì˜¤ë˜ ìœ ì§€ë˜ë„ë¡ ë³€ê²½
        setInterval(changeBackgroundImage, changeInterval);
        

        // í…ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadChatData() {
            try {
                const response = await fetch("text.txt");
                const text = await response.text();
                chatData = text.trim().split("\n");
                console.log(`âœ… ì±„íŒ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${chatData.length}ì¤„`);
                loadingIndicator.style.display = "none"; // ğŸ”§ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                renderMessagesAround(1); // ğŸ”§ 1ë²ˆì§¸ ë©”ì‹œì§€ë¶€í„° ë Œë”ë§

                // ğŸ”¥ ë©”ì‹œì§€ê°€ ë Œë”ë§ëœ í›„ 1ë²ˆì§¸ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
                setTimeout(() => {
                    scrollToMessage(6);
                }, 100);
            } catch (error) {
                console.error("âŒ ì±„íŒ… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        let loadedStart = 0;
        let loadedEnd = 0;
        
        // íŠ¹ì • ìœ„ì¹˜ ì£¼ë³€ ë©”ì‹œì§€ ë Œë”ë§ (ì´ˆê¸° ë˜ëŠ” íŠ¹ì • ìœ„ì¹˜ ì´ë™ ì‹œ)
        function renderMessagesAround(targetIndex) {
            messageContainer.innerHTML = ""; // ê¸°ì¡´ ë©”ì‹œì§€ ì‚­ì œ
        
            let start = Math.max(0, targetIndex - 300);
            let end = Math.min(chatData.length, targetIndex + 100);
        
            loadedStart = start;
            loadedEnd = end;
        
            console.log(`ğŸ”„ ${start}~${end}ë²ˆì§¸ ë©”ì‹œì§€ ë Œë”ë§`);
        
            for (let i = start; i < end; i++) {
                renderSingleMessage(chatData[i], i);
            }
        
            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì¶”ê°€ (ì¶”ê°€ ë¡œë“œ ê°ì§€)
            chatContainer.addEventListener("scroll", handleScroll);
        
            // ìŠ¤í¬ë¡¤ì„ ì¤‘ì•™ì— ë§ì¶¤
            setTimeout(() => {
                const targetMessage = document.querySelector(`.message-index[data-index="${targetIndex}"]`);
                if (targetMessage) {
                    targetMessage.closest(".message-item").scrollIntoView({ behavior: "instant", block: "center" });
                }
            }, 100);
        }
        
        // ìŠ¤í¬ë¡¤ ê°ì§€ ì´ë²¤íŠ¸
        function handleScroll() {
            if (chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 10) {
                // ğŸ”¥ ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ë©´ ë‹¤ìŒ 1000ê°œ ë¡œë“œ
                loadMoreMessages("down");
            }
        }
        
        function loadMoreMessages(direction) {
            let newStart, newEnd;
        
            if (direction === "down") {
                newStart = loadedEnd;  // í˜„ì¬ ë¡œë“œëœ ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ë¶€í„°
                newEnd = Math.min(chatData.length, loadedEnd + 100); // 1000ê°œ ì¶”ê°€
            } else {
                return; // ìœ„ìª½ ë¡œë“œëŠ” ì´ë²ˆ ì½”ë“œì—ì„œ í•„ìš” ì—†ìŒ
            }
        
            if (newStart === loadedStart && newEnd === loadedEnd) return; // ì¤‘ë³µ ë¡œë“œ ë°©ì§€
        
            console.log(`ğŸ”„ ì¶”ê°€ ë¡œë“œ: ${newStart}~${newEnd}`);
        
            for (let i = newStart; i < newEnd; i++) {
                renderSingleMessage(chatData[i], i);
            }
        
            loadedEnd = newEnd; // ë§ˆì§€ë§‰ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        }
        
        // ê°œë³„ ë©”ì‹œì§€ ë Œë”ë§
        function renderSingleMessage(line, index) {
            const messagePattern = /\[(.*?)\] \[(.*?)\] (.*)/;
            const match = line.match(messagePattern);
            if (!match) return;
        
            const [, sender, time, text] = match;
            const isUser = sender === "ìµœë‹¤í›ˆ";
        
            const messageElement = document.createElement("div");
            messageElement.className = `message-item flex ${isUser ? 'justify-start' : 'justify-end'} mb-4`;
            messageElement.innerHTML = `
                <div class="max-w-xs p-3 rounded-lg chat-bubble ${isUser ? 'chat-user' : 'chat-other'} shadow-md">
                    <p class="text-xs font-bold">${sender} â€¢ ${time} <span class="message-index" data-index="${index}">#${index}</span></p>
                    <p class="mt-1">${text}</p>
                </div>
            `;
        
            messageContainer.appendChild(messageElement);
        }
        
        // íŠ¹ì • ë©”ì‹œì§€ë¡œ ì´ë™
        function scrollToMessage(targetIndex) {
            if (chatData.length === 0) return;
            renderMessagesAround(targetIndex);
        }
        
        // ì±„íŒ… ë°ì´í„° ë¡œë“œ
        loadChatData();
    </script>

</body>

</html>